name: TikTok NBA Script Generator

on:
  workflow_dispatch: # Allows manual triggering
  schedule:
    - cron: '0 12 * * *'  # Run daily at 12 PM UTC

permissions:
  contents: write

jobs:
  generate-tiktok-script:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: pip install requests beautifulsoup4 edge-tts nest_asyncio pillow
    
    - name: Create source directory and clean old files
      run: |
        mkdir -p source
        echo "Checking for existing files to replace..."
        if [ -f "source/headline.txt" ]; then
          echo "Removing existing headline.txt"
          rm "source/headline.txt"
        fi
        if [ -f "source/script.txt" ]; then
          echo "Removing existing script.txt"
          rm "source/script.txt"
        fi
        if [ -f "source/image.jpg" ]; then
          echo "Removing existing image.jpg"
          rm "source/image.jpg"
        fi
        if [ -f "source/voiceover.mp3" ]; then
          echo "Removing existing voiceover.mp3"
          rm "source/voiceover.mp3"
        fi
        echo "Ready to generate new files..."
    
    - name: Generate TikTok Script and files
      run: |
        python3 - <<EOF
        import requests
        from bs4 import BeautifulSoup
        import json
        import asyncio
        import edge_tts
        import nest_asyncio
        from PIL import Image
        import io
        import os
        import time
        import urllib.parse

        # Allow async in some environments
        nest_asyncio.apply()

        # Scraper for NBA article
        def scrape_nba_news(url):
            headers = {'User-Agent': 'Mozilla/5.0'}
            try:
                response = requests.get(url, headers=headers)
                soup = BeautifulSoup(response.text, 'html.parser')

                # Headline
                h1 = soup.find('header', class_='entry-header')
                headline = h1.find('h1').get_text(strip=True) if h1 else 'No headline found'

                # Article content
                content_div = soup.find('div', class_='entry-content')
                article_text = content_div.get_text(separator=' ', strip=True) if content_div else 'No content found'

                # Image URL
                og_image = soup.find('meta', property='og:image')
                img_url = og_image['content'] if og_image and og_image.has_attr('content') else 'No image found'

                return headline, article_text, img_url
            except Exception as e:
                print(f'Error scraping: {e}')
                return None, None, None

        # Multiple API fallback system
        def generate_tiktok_script_fallback(headline, article_content):
            prompt = f"""
        You are writing a TikTok NBA commentary script for a text-to-speech voice.

        CRITICAL TTS RULES for perfect natural speech:
        - Write like you are having an excited conversation with a friend
        - Add commas when you would naturally take a breath while speaking
        - Use commas to separate different thoughts or topics
        - Add commas after team names when transitioning to what they did
        - Put commas before "but", "and", "so" when connecting major ideas
        - Do not overdo it - aim for 2-4 word groups between most commas
        - NO periods, colons, dashes, or any punctuation except commas and ONE period at the very end
        - Instead of "grade: B" say "I give them a B" or "that is a solid B grade"
        - NO symbols like colons, dashes, hyphens - only words and commas
        - Sound enthusiastic and natural, not robotic or rushed
        - Be under 60 seconds when spoken

        NBA Headline: {headline}
        Article Info: {article_content}

        Write with natural speech rhythm and spell out grades naturally. NO colons, dashes, or symbols - just words and commas. Output just the script.
        """

            # Method 1: Try Pollinations GET API
            try:
                print("Trying Pollinations GET API...")
                encoded_prompt = urllib.parse.quote(prompt)
                url = f"https://text.pollinations.ai/{encoded_prompt}"
                
                headers = {'User-Agent': 'Mozilla/5.0'}
                response = requests.get(url, headers=headers, timeout=30)
                
                if response.status_code == 200:
                    print("âœ… Pollinations GET API successful")
                    return response.text.strip()
                else:
                    print(f"âŒ Pollinations GET API failed with status {response.status_code}")
            except Exception as e:
                print(f"âŒ Pollinations GET API error: {e}")

            # Wait between attempts to respect rate limits
            time.sleep(4)

            # Method 2: Try Pollinations POST API with retry logic
            try:
                print("Trying Pollinations POST API...")
                
                headers = {
                    'Content-Type': 'application/json',
                    'User-Agent': 'Mozilla/5.0'
                }

                data = {
                    'model': 'openai',
                    'messages': [{'role': 'user', 'content': prompt}],
                    'max_tokens': 380,
                    'temperature': 0.9,
                    'top_p': 0.95
                }

                # Retry logic for 502 errors
                max_retries = 3
                for attempt in range(max_retries):
                    try:
                        response = requests.post('https://text.pollinations.ai/openai', 
                                               headers=headers, json=data, timeout=30)
                        
                        if response.status_code == 200:
                            result = response.json()
                            script = result['choices'][0]['message']['content'].strip()
                            print("âœ… Pollinations POST API successful")
                            return script
                        elif response.status_code == 502:
                            print(f"âŒ 502 error on attempt {attempt + 1}, retrying...")
                            time.sleep(5)  # Wait longer for 502 errors
                        else:
                            print(f"âŒ API returned status {response.status_code}")
                            break
                    except requests.exceptions.RequestException as e:
                        print(f"âŒ Request error on attempt {attempt + 1}: {e}")
                        time.sleep(3)
                
            except Exception as e:
                print(f"âŒ Pollinations POST API error: {e}")

            # Method 3: Fallback to a simple template-based script
            print("Using fallback template script...")
            return generate_fallback_script(headline, article_content)

        def generate_fallback_script(headline, article_content):
            # Create a basic script template when APIs fail
            script_templates = [
                f"Alright NBA fans, big news just dropped, {headline[:100]}, this is exactly what we have been waiting for, the league is getting more competitive, and honestly this move makes total sense, what do you think about this trade, comment below and let me know your thoughts.",
                f"NBA update everyone, so {headline[:100]}, and I have to say this is pretty interesting, the front office is making moves, this could change everything for the playoffs, definitely keeps things exciting, what is your prediction for this season.",
                f"Breaking NBA news, {headline[:100]}, and wow this is huge for the franchise, they are building something special here, the chemistry is going to be amazing, I cannot wait to see how this plays out, drop your reactions in the comments."
            ]
            
            import random
            return random.choice(script_templates)

        # Download and save image with better error handling
        def download_image(img_url, output_path):
            try:
                if img_url == 'No image found' or not img_url:
                    print("No image URL provided")
                    return False
                
                headers = {'User-Agent': 'Mozilla/5.0'}
                response = requests.get(img_url, headers=headers, timeout=15)
                response.raise_for_status()
                
                # Open and save image as JPG
                image = Image.open(io.BytesIO(response.content))
                # Convert to RGB if necessary (for JPG format)
                if image.mode in ('RGBA', 'P'):
                    image = image.convert('RGB')
                image.save(output_path, 'JPEG', quality=90)
                return True
            except Exception as e:
                print(f'Error downloading image: {e}')
                return False

        # Save to MP3 with Edge TTS
        async def save_script_to_voice(script_text, voice='en-US-GuyNeural', output_path='source/voiceover.mp3'):
            try:
                communicate = edge_tts.Communicate(script_text, voice)
                await communicate.save(output_path)
            except Exception as e:
                print(f'Error generating TTS: {e}')

        # Main function with better error handling
        async def main():
            url = 'https://www.basketballinsiders.org/news/warriors-cavaliers-mavericks-expected-to-pursue-lebron-james-in-2026/'
            
            print(f"Scraping article from: {url}")
            headline, article_content, img_url = scrape_nba_news(url)

            if not headline or headline == 'No headline found':
                print('âŒ Failed to scrape article. Using fallback content.')
                headline = 'NBA Trade Rumors and Updates'
                article_content = 'Latest NBA news and trade discussions from around the league.'

            print(f'ðŸ“° Headline: {headline}')
            print()

            script = generate_tiktok_script_fallback(headline, article_content)
            print('ðŸŽ¬ TTS-Friendly TikTok Voiceover Script:')
            print()
            print(script)
            print()
            print(f'ðŸ–¼ï¸ Image URL: {img_url}')

            # Save headline to file
            try:
                with open('source/headline.txt', 'w', encoding='utf-8') as f:
                    f.write(headline)
                print('âœ… Headline saved to source/headline.txt')
            except Exception as e:
                print(f'âŒ Error saving headline: {e}')

            # Save generated script to file
            try:
                with open('source/script.txt', 'w', encoding='utf-8') as f:
                    f.write(script)
                print('âœ… Script saved to source/script.txt')
            except Exception as e:
                print(f'âŒ Error saving script: {e}')

            # Download and save image
            image_saved = download_image(img_url, 'source/image.jpg')
            if image_saved:
                print('âœ… Image saved to source/image.jpg')
            else:
                print('âš ï¸ Image could not be saved')

            # Generate TTS voiceover
            print()
            print('ðŸ”Š Generating voiceover MP3 with Edge TTS...')
            await save_script_to_voice(script, voice='en-US-GuyNeural', output_path='source/voiceover.mp3')
            print('âœ… Voiceover saved to source/voiceover.mp3')

        # Run script
        try:
            asyncio.run(main())
        except Exception as e:
            print(f'âŒ Critical error: {e}')
            exit(1)
        EOF

    - name: Set up Git identity
      run: |
        git config --global user.name "cowboycode9"
        git config --global user.email "cowboycode9@outlook.com"

    - name: Commit and push generated files
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        git stash --include-untracked
        git pull origin main --rebase || echo "Warning: rebase skipped"
        git stash pop || true

        git add source/
        timestamp=$(TZ="UTC" date +"%Y-%m-%d %H:%M:%S UTC")
        git commit -m "Generated TikTok NBA script and assets: ${timestamp}" || echo "No changes to commit"
        git push https://x-access-token:${GH_PAT}@github.com/${{ github.repository }}.git HEAD:main
